<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Ability Battle</title>
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #log { white-space: pre-line; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background: #f9f9f9; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Ability Battle</h1>

  <!-- ãƒ­ã‚°è¡¨ç¤º -->
  <div id="log"></div>

  <!-- èƒ½åŠ›ãƒœã‚¿ãƒ³ -->
  <button id="attackBtn">æ”»æ’ƒ</button>
  <button id="fireballBtn">ç«çƒ</button>
  <button id="guardBtn">é˜²å¾¡</button>
  <button id="healBtn">å›å¾©</button>

  <py-script>
import random
from js import document

# ===== ãƒ­ã‚°å‡ºåŠ›é–¢æ•° =====
def log(text):
    log_div = document.getElementById("log")
    log_div.innerHTML += text + "\n"
    log_div.scrollTop = log_div.scrollHeight  # è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

# ===== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ =====
class Character:
    def __init__(self, name):
        self.name = name
        self.hp = 100
        self.mp = 50
        self.guard = False

    def take_damage(self, dmg):
        if self.guard:
            dmg = dmg // 2
            self.guard = False
            log(f"{self.name}ã¯é˜²å¾¡ã—ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸åŠæ¸›ï¼")
        self.hp -= dmg
        if self.hp < 0:
            self.hp = 0

# ===== èƒ½åŠ› =====
def attack(user, target):
    dmg = random.randint(10, 20)
    log(f"{user.name}ã®æ”»æ’ƒï¼ {dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸")
    target.take_damage(dmg)

def fireball(user, target):
    cost = 15
    if user.mp < cost:
        log("MPãŒè¶³ã‚Šãªã„ï¼")
        return
    user.mp -= cost
    dmg = random.randint(20, 35)
    log(f"{user.name}ã®ğŸ”¥ç«çƒï¼ {dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸")
    target.take_damage(dmg)

def guard(user, target):
    cost = 5
    if user.mp < cost:
        log("MPãŒè¶³ã‚Šãªã„ï¼")
        return
    user.mp -= cost
    user.guard = True
    log(f"{user.name}ã¯ğŸ›¡é˜²å¾¡æ…‹å‹¢ã«å…¥ã£ãŸ")

def heal(user, target):
    cost = 10
    if user.mp < cost:
        log("MPãŒè¶³ã‚Šãªã„ï¼")
        return
    user.mp -= cost
    amount = random.randint(15, 25)
    user.hp += amount
    if user.hp > 100:
        user.hp = 100
    log(f"{user.name}ã¯âœ¨å›å¾©ï¼ HPãŒ{amount}å›å¾©ã—ãŸ")

abilities = [attack, fireball, guard, heal]

# ===== AI =====
def ai_choose_ability(ai, enemy):
    if ai.hp <= 30 and ai.mp >= 10 and random.random() < 0.7:
        return 3  # å›å¾©
    if enemy.hp <= 25 and ai.mp >= 15:
        return 1  # ç«çƒ
    if ai.mp < 15:
        return 0  # æ”»æ’ƒ
    return random.randint(0, 3)

# ===== ã‚¿ãƒ¼ãƒ³å‡¦ç† =====
def turn(player, enemy, choice=None, is_ai=False):
    # ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚MPå›å¾©
    player.mp += 5
    if player.mp > 50:
        player.mp = 50

    log(f"\n--- {player.name}ã®ã‚¿ãƒ¼ãƒ³ ---")
    log(f"{player.name} HP: {player.hp} / MP: {player.mp}")
    log(f"{enemy.name} HP: {enemy.hp} / MP: {enemy.mp}")

    if is_ai:
        choice = ai_choose_ability(player, enemy)

    abilities[choice](player, enemy)

# ===== ã‚²ãƒ¼ãƒ åˆæœŸåŒ– =====
player1 = Character("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼A")
player2 = Character("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼B")
turn_count = 1

# ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ =====
def player_choice(choice):
    global turn_count
    if player1.hp <= 0 or player2.hp <= 0:
        return

    # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ¼ãƒ³
    turn(player1, player2, choice)
    if player2.hp <= 0:
        log("\n====== ãƒãƒˆãƒ«çµ‚äº† ======")
        log("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼Aã®å‹åˆ©ï¼")
        return

    # AIã‚¿ãƒ¼ãƒ³
    turn(player2, player1, is_ai=True)
    if player1.hp <= 0:
        log("\n====== ãƒãƒˆãƒ«çµ‚äº† ======")
        log("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼Bã®å‹åˆ©ï¼")
        return

    turn_count += 1

# ===== ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ =====
document.getElementById("attackBtn").element.onclick = lambda e: player_choice(0)
document.getElementById("fireballBtn").element.onclick = lambda e: player_choice(1)
document.getElementById("guardBtn").element.onclick = lambda e: player_choice(2)
document.getElementById("healBtn").element.onclick = lambda e: player_choice(3)
  </py-script>
</body>
</html>
